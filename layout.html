<!-- templates/layout.html -->
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>查詢教室課表</title>
  {{ source_head|safe }}
  <style>
    /* 整體置中容器 */
    body.seach, html {
      height: 100%;
      margin: 0;
      font-family: sans-serif;
      display: flex;
      justify-content: center; /* 水平置中 */
      align-items: flex-start; /* 靠上排列避免被頂住 */
      background: #f9f9f9;
      padding: 20px 0; /* 預留頂部空間 */
    }
    /* 主容器，寬度自動根據課表寬度調整 */
    #search-container {
      background: white;
      padding: 2em;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      /* 課表最大寬度調整為 1070px */
      max-width: 1070px;
      width: 100%;
      box-sizing: border-box;
    }
    /* 表單排版，查詢框與教室選單同一行 */
    form {
      display: flex;
      align-items: center; /* 使子元素垂直置中 */
      gap: 0.5em;
      flex-wrap: nowrap;
      margin-bottom: 1em; /* 查詢結果上方留空 */
    }
    label {
      font-weight: bold;
      white-space: nowrap;
      /* 垂直置中用 margin 自動調整 */
      margin: 0;
      display: flex;
      align-items: center;
    }
    select, button {
      font-size: 1em;
      padding: 0.3em 0.6em;
      margin: 0; /* 清除預設 margin */
      height: 2.2em; /* 統一高度，讓垂直置中更美觀 */
      display: flex;
      align-items: center;
    }
    select {
      min-width: 140px;
    }
    button {
      cursor: pointer;
      white-space: nowrap;
    }
    /* 查詢結果區域 */
    #result {
      overflow-x: auto;
      min-height: 400px; /* 預留空間避免跳動 */
    }
    /* loading modal */
    #loadingModal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0; top: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.3);
    }
    #loadingModal .modal-content {
      /* 視窗大小改為 120x150 px */
      width: 120px;
      height: 150px;
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border-radius: 10px;
      box-shadow: 0 0 10px #333;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 0;
      box-sizing: border-box;
      text-align: center;
    }
    #loadingModal .modal-content img {
      width: 100px;
      height: 100px;
      display: block;
      margin: 0 auto;
    }
    #loadingModal .modal-content span {
      margin-top: 8px;
      font-size: 14px;
      color: #333;
      user-select: none;
      width: 100%;
    }
  </style>
</head>
<body class="body.seach">
  <div id="search-container">
    <h2>查詢教室課表</h2>
    <!-- 查詢表單，學年期、教室與查詢按鈕同列，垂直置中 -->
    <form id="queryForm" aria-label="查詢教室課表表單">
      <label for="year">學年/學期：</label>
      <select id="year" name="year" aria-label="學年期">
        {{ year_html|safe }}
      </select>
      <label for="room">教室：</label>
      <select id="room" name="room" aria-label="教室">
        {{ room_html|safe }}
      </select>
      <button type="submit" aria-label="開始查詢">查詢</button>
    </form>
    <!-- 查詢結果區域 -->
    <div id="result"></div>
  </div>

  <!-- loading 小視窗，gif 與文字都在視窗內置中 -->
  <div id="loadingModal" role="alert" aria-live="assertive" aria-hidden="true">
    <div class="modal-content">
      <img src="{{ url_for('static', filename='loading1.gif') }}" alt="查詢中，請稍候" />
      <span>查詢中...</span>
    </div>
  </div>

  <script>
    // 顯示 loading 視窗
    function showLoading() {
      const modal = document.getElementById('loadingModal');
      modal.style.display = 'block';
      modal.setAttribute('aria-hidden', 'false');
    }
    // 隱藏 loading 視窗
    function hideLoading() {
      const modal = document.getElementById('loadingModal');
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden', 'true');
    }
    // 綁定查詢表單提交事件
    document.getElementById('queryForm').addEventListener('submit', function(e){
      e.preventDefault();
      const year = document.getElementById('year').value;
      const room = document.getElementById('room').value;
      const resultDiv = document.getElementById('result');
      showLoading();
      fetch('/fetch?year=' + encodeURIComponent(year) + '&room=' + encodeURIComponent(room))
        .then(response => response.json())
        .then(data => {
          hideLoading();
          if(data.error){
            resultDiv.innerHTML = `<span style="color:red;">查詢失敗：${data.error}</span>`;
          } else {
            // 更新 head 中 CSS/JS，確保樣式一致
            const parser = new DOMParser();
            const doc = parser.parseFromString('<head>' + data.head + '</head>', 'text/html');
            const newHead = doc.head;
            const myHead = document.head;
            Array.from(myHead.querySelectorAll('link[rel=stylesheet],script')).forEach(e => e.remove());
            Array.from(newHead.children).forEach(node => {
              if(['LINK', 'STYLE', 'SCRIPT'].includes(node.tagName)){
                myHead.appendChild(node.cloneNode(true));
              }
            });
            // 顯示查詢結果表格
            resultDiv.innerHTML = data.table;
          }
        })
        .catch(() => {
          hideLoading();
          resultDiv.innerHTML = `<span style="color:red;">發生錯誤，請稍後再試</span>`;
        });
    });
  </script>
</body>
</html>
